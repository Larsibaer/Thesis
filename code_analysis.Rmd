---
title: "Code Analysis"
author: "Lars Wenger"
date: "2024-03-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Import Libraries
```{r echo = T, results = 'hide'}
libraries = c( "fpp3", "ggplot2", "dplyr", "tidyr", "readxl", "forecast", "zoo", "tsibble", "GGally", "lubridate", "tidyverse", "stringi")

lapply(libraries, function(x) if (!(x %in% installed.packages())) {
  install.packages(x)
})

lapply(libraries, library, quietly = TRUE, character.only = TRUE)
```

# Read Data
```{r read_data}
rm(list=ls())

setwd("C:/Thesis")

cluster_data <- read_csv("Data/data_withclusters.csv", locale = locale(encoding = "UTF-8"))
vect_desc_data <- read_csv("Data/VectorizedText_description.csv", locale = locale(encoding = "UTF-8"))
vect_cause_data <- read_csv("Data/VectorizedText_cause.csv", locale = locale(encoding = "UTF-8"))
vect_clause_notes_data <- read_csv("Data/VectorizedText_close_notes.csv", locale = locale(encoding = "UTF-8"))
proportion_data <- read_csv("Data/data_proportion.csv", locale = locale(encoding = "UTF-8"))


#Merge all data by number
data_all <- cluster_data %>%
  inner_join(vect_desc_data, by = c("number" = "number")) %>%
  inner_join(vect_cause_data, by = c("number" = "number")) %>%
  inner_join(vect_clause_notes_data, by = c("number" = "number")) %>%
  inner_join(proportion_data, by = c("number" = "number"))
```

```{r}
con<-file('Data/data_all.csv',encoding="UTF-8")
#save data_all as csv
write.csv(data_all, file = con)
```
```{r}
data_all$cluster <- as.factor(data_all$cluster)
# Plot a Boxplot of each Cluster for openedToClosed and time_worked
ggplot(data_all, aes(x = cluster, y = data_all$openedToClosed)) + 
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Distribution of Opened to Closed Across Clusters", y = "Opened to Closed (Hours)", x = "Cluster")

data_all$cluster <- as.factor(data_all$cluster)
# Plot a Boxplot of each Cluster for openedToClosed and time_worked
ggplot(data_all, aes(x = cluster, y = data_all$time_worked)) + 
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Distribution of Time Worked Across Clusters", y = "Time Worked (Hours)", x = "Cluster")
```

```{r}
# Select the columns that contains "prop_state" in the name
state_index <- grep("prop_state", colnames(data_all))
# Make new datafram with columns 1-6 and 20-25
data_prop_state <- select(data_all, number, cluster, c(state_index))

# grouping the data by the cluster number, calculating the average duration for tickets within each cluster, and then visualizing these averages to identify any notable differences among the clusters.
data_prop_state %>%
  group_by(cluster) %>%
  summarise_all(mean) %>%
  pivot_longer(cols = c(3:length(data_prop_state)), names_to = "variable", values_to = "value") %>%
  ggplot(aes(x = cluster, y = value, fill = variable)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Average Duration of Tickets by Cluster",
       x = "Cluster",
       y = "Average Duration",
       fill = "Variable") +
  theme_minimal()
```

```{r}
# Select the columns that contains "prop_state" in the name
user_index <- grep("prop_user", colnames(data_all))

data_prop_user <- select(data_all, number, cluster, c(user_index))

# Replace NA with 0
data_prop_user[is.na(data_prop_user)] <- 0

# get length of data_prop_user
length(data_prop_user)


# usering the data by the cluster number, calculating the average duration for tickets within each cluster, and then visualizing these averages to identify any notable differences among the clusters.
data_prop_user %>%
  group_by(cluster) %>%
  summarise_all(mean) %>%
  pivot_longer(cols = c(3:length(data_prop_user)), names_to = "variable", values_to = "value") %>%
  ggplot(aes(x = cluster, y = value, fill = variable)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Average Duration of Tickets by Cluster",
       x = "Cluster",
       y = "Average Duration",
       fill = "Variable") +
  theme_minimal()
```
```{r}
# Select the columns that contains "prop_state" in the name
group_index <- grep("prop_group", colnames(data_all))

data_prop_group <- select(data_all, number, cluster, c(group_index))

# Replace NA with 0
data_prop_group[is.na(data_prop_group)] <- 0


# grouping the data by the cluster number, calculating the average duration for tickets within each cluster, and then visualizing these averages to identify any notable differences among the clusters.
data_prop_group %>%
  group_by(cluster) %>%
  summarise_all(mean) %>%
  pivot_longer(cols = c(3:length(data_prop_group)), names_to = "variable", values_to = "value") %>%
  ggplot(aes(x = cluster, y = value, fill = variable)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Average Duration of Tickets by Cluster",
       x = "Cluster",
       y = "Average Duration",
       fill = "Variable") +
  theme_minimal()
```

```{r}
```




